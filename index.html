<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Race - Multiplayer Icebreaker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBPPWgQNt-TJi0mvHIKsFsW1BIrJHoSLzM",
            authDomain: "dice-race-a2698.firebaseapp.com",
            databaseURL: "https://dice-race-a2698-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dice-race-a2698",
            storageBucket: "dice-race-a2698.firebasestorage.app",
            messagingSenderId: "879265115512",
            appId: "1:879265115512:web:aedce421a62e4f7b5dac8d"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameRef = database.ref('game');

        // Icons as SVG components
        const DicesIcon = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
                <circle cx="6.5" cy="6.5" r="0.5" fill="currentColor"/>
                <circle cx="17.5" cy="17.5" r="0.5" fill="currentColor"/>
            </svg>
        );

        const TrophyIcon = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );

        const UsersIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const RotateIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 2v6h-6"/>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                <path d="M3 22v-6h6"/>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
            </svg>
        );

        const ShieldIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
        );

        const ZapIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );

        const CircleIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
            </svg>
        );

        const DiceRaceGame = () => {
            const [gameState, setGameState] = useState(null);
            const [playerName, setPlayerName] = useState('');
            const [hasJoined, setHasJoined] = useState(false);
            const [isRolling, setIsRolling] = useState(false);
            const [diceValue, setDiceValue] = useState(null);
            const [loading, setLoading] = useState(true);
            const WINNING_POSITION = 30;

            useEffect(() => {
                const unsubscribe = gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.players && Array.isArray(data.players)) {
                        setGameState(data);
                    } else {
                        const initialState = {
                            players: [],
                            currentPlayerIndex: 0,
                            gameStarted: false,
                            winner: null
                        };
                        gameRef.set(initialState).catch(err => console.error('Error setting initial state:', err));
                        setGameState(initialState);
                    }
                    setLoading(false);
                });

                return () => gameRef.off('value', unsubscribe);
            }, []);

            const joinGame = () => {
                if (playerName.trim() && gameState && !gameState.gameStarted) {
                    const existingPlayer = gameState.players.find(p => p.name === playerName.trim());
                    if (!existingPlayer) {
                        const newPlayers = [...gameState.players, { name: playerName.trim(), position: 0 }];
                        gameRef.update({ players: newPlayers }).catch(err => console.error('Error joining game:', err));
                    }
                    setHasJoined(true);
                }
            };

            const startGame = () => {
                if (gameState && gameState.players.length >= 2) {
                    gameRef.update({
                        gameStarted: true,
                        currentPlayerIndex: 0
                    }).catch(err => console.error('Error starting game:', err));
                }
            };

            const rollDice = (diceType) => {
                if (isRolling || !gameState || gameState.winner || !gameState.players || gameState.players.length === 0) return;
                
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                if (!currentPlayer || currentPlayer.name !== playerName) return;

                setIsRolling(true);

                let rolls = 0;
                const rollInterval = setInterval(() => {
                    let randomValue;
                    if (diceType === 'safe') {
                        randomValue = Math.random() < 0.5 ? 3 : 4;
                    } else if (diceType === 'risky') {
                        const riskyOptions = [1, 2, 6];
                        randomValue = riskyOptions[Math.floor(Math.random() * 3)];
                    } else {
                        randomValue = Math.floor(Math.random() * 6) + 1;
                    }
                    setDiceValue(randomValue);
                    rolls++;
                    
                    if (rolls > 10) {
                        clearInterval(rollInterval);
                        let finalValue;
                        if (diceType === 'safe') {
                            finalValue = Math.random() < 0.5 ? 3 : 4;
                        } else if (diceType === 'risky') {
                            const riskyOptions = [1, 2, 6];
                            finalValue = riskyOptions[Math.floor(Math.random() * 3)];
                        } else {
                            finalValue = Math.floor(Math.random() * 6) + 1;
                        }
                        setDiceValue(finalValue);
                        
                        setTimeout(() => {
                            const newPlayers = [...gameState.players];
                            newPlayers[gameState.currentPlayerIndex].position += finalValue;
                            
                            let newWinner = null;
                            if (newPlayers[gameState.currentPlayerIndex].position >= WINNING_POSITION) {
                                newPlayers[gameState.currentPlayerIndex].position = WINNING_POSITION;
                                newWinner = newPlayers[gameState.currentPlayerIndex].name;
                            }
                            
                            gameRef.update({
                                players: newPlayers,
                                winner: newWinner,
                                currentPlayerIndex: newWinner ? gameState.currentPlayerIndex : (gameState.currentPlayerIndex + 1) % gameState.players.length
                            }).catch(err => console.error('Error updating game:', err));
                            
                            setIsRolling(false);
                        }, 500);
                    }
                }, 100);
            };

            const resetGame = () => {
                const newState = {
                    players: [],
                    currentPlayerIndex: 0,
                    gameStarted: false,
                    winner: null
                };
                gameRef.set(newState).catch(err => console.error('Error resetting game:', err));
                setHasJoined(false);
                setPlayerName('');
                setDiceValue(null);
            };

            const restartRace = () => {
                if (gameState && gameState.players) {
                    const resetPlayers = gameState.players.map(p => ({ ...p, position: 0 }));
                    gameRef.update({
                        players: resetPlayers,
                        currentPlayerIndex: 0,
                        winner: null
                    }).catch(err => console.error('Error restarting race:', err));
                    setDiceValue(null);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-white text-2xl">Loading...</div>
                    </div>
                );
            }

            if (!gameState) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-white text-2xl">Initializing game...</div>
                    </div>
                );
            }

            if (!hasJoined || !gameState.gameStarted) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-8 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-6">
                                <div className="flex justify-center mb-4 text-purple-600">
                                    <DicesIcon />
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Dice Race</h1>
                                <p className="text-gray-600">Multiplayer icebreaker game</p>
                            </div>

                            {!hasJoined ? (
                                <div className="mb-6">
                                    <input
                                        type="text"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && joinGame()}
                                        placeholder="Enter your name"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none mb-4"
                                    />
                                    <button
                                        onClick={joinGame}
                                        className="w-full py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                                    >
                                        Join Game
                                    </button>
                                </div>
                            ) : (
                                <div className="mb-6">
                                    <p className="text-center text-green-600 font-semibold mb-4">‚úì You've joined as {playerName}</p>
                                </div>
                            )}

                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                <h3 className="font-semibold mb-2 text-gray-700">Players ({gameState.players?.length || 0}):</h3>
                                {!gameState.players || gameState.players.length === 0 ? (
                                    <p className="text-gray-400 text-center py-4">Waiting for players...</p>
                                ) : (
                                    <div className="space-y-2">
                                        {gameState.players.map((player, idx) => (
                                            <div key={idx} className="bg-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2">
                                                <UsersIcon />
                                                <span className="font-medium">{player.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {hasJoined && !gameState.gameStarted && (
                                <button
                                    onClick={startGame}
                                    disabled={!gameState.players || gameState.players.length < 2}
                                    className="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-bold text-lg hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {!gameState.players || gameState.players.length < 2 ? 'Need at least 2 players' : 'Start Race!'}
                                </button>
                            )}

                            {gameState.gameStarted && (
                                <p className="text-center text-blue-600 font-semibold">Game has started! Loading...</p>
                            )}
                        </div>
                    </div>
                );
            }

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.name === playerName;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-4 md:p-8">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Dice Race</h1>
                                    <p className="text-sm text-gray-600">Playing as: {playerName}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={restartRace}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 text-sm"
                                    >
                                        <RotateIcon />
                                        New Race
                                    </button>
                                    <button
                                        onClick={resetGame}
                                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
                                    >
                                        New Game
                                    </button>
                                </div>
                            </div>

                            {gameState.winner && (
                                <div className="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-6 mb-8 text-center">
                                    <div className="flex justify-center mb-4 text-white">
                                        <TrophyIcon />
                                    </div>
                                    <h2 className="text-2xl md:text-3xl font-bold text-white mb-2">üéâ {gameState.winner} Wins! üéâ</h2>
                                </div>
                            )}

                            <div className="mb-8 space-y-3">
                                {gameState.players && gameState.players.map((player, idx) => {
                                    const isCurrentPlayer = idx === gameState.currentPlayerIndex && !gameState.winner;
                                    const progress = (player.position / WINNING_POSITION) * 100;
                                    
                                    return (
                                        <div key={idx} className={`p-3 md:p-4 rounded-xl transition-all ${isCurrentPlayer ? 'bg-purple-100 border-2 border-purple-500' : 'bg-gray-50'}`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className={`font-bold text-base md:text-lg ${isCurrentPlayer ? 'text-purple-700' : 'text-gray-700'}`}>
                                                    {player.name}
                                                    {isCurrentPlayer && !gameState.winner && ' üëà'}
                                                </span>
                                                <span className="text-xs md:text-sm font-semibold text-gray-600">
                                                    {player.position}/{WINNING_POSITION}
                                                </span>
                                            </div>
                                            <div className="relative h-8 bg-gray-200 rounded-full overflow-hidden">
                                                <div 
                                                    className="absolute h-full bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500"
                                                    style={{ width: `${Math.min(progress, 100)}%` }}
                                                />
                                                <div 
                                                    className="absolute h-full flex items-center transition-all duration-500"
                                                    style={{ left: `${Math.min(progress, 95)}%` }}
                                                >
                                                    <span className="text-2xl">üèÉ</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {!gameState.winner && (
                                <div className="text-center">
                                    <div className="mb-6">
                                        <p className="text-lg md:text-xl font-semibold text-gray-700 mb-4">
                                            {isMyTurn ? "Your turn!" : `${currentPlayer?.name || 'Someone'}'s turn`}
                                        </p>
                                        {diceValue && (
                                            <div className="inline-block bg-white border-4 border-purple-500 rounded-2xl p-6 md:p-8 shadow-xl mb-4">
                                                <div className="text-5xl md:text-7xl font-bold text-purple-600">{diceValue}</div>
                                            </div>
                                        )}
                                    </div>

                                    {isMyTurn ? (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-2">Choose your dice:</p>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 max-w-3xl mx-auto">
                                                <button
                                                    onClick={() => rollDice('safe')}
                                                    disabled={isRolling}
                                                    className="p-4 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 disabled:opacity-50 transition-all transform hover:scale-105 flex flex-col items-center gap-2"
                                                >
                                                    <ShieldIcon />
                                                    <span className="text-lg">Safe Dice</span>
                                                    <span className="text-xs opacity-90">Roll 3 or 4</span>
                                                </button>
                                                
                                                <button
                                                    onClick={() => rollDice('normal')}
                                                    disabled={isRolling}
                                                    className="p-4 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 disabled:opacity-50 transition-all transform hover:scale-105 flex flex-col items-center gap-2"
                                                >
                                                    <CircleIcon />
                                                    <span className="text-lg">Normal Dice</span>
                                                    <span className="text-xs opacity-90">Roll 1-6</span>
                                                </button>
                                                
                                                <button
                                                    onClick={() => rollDice('risky')}
                                                    disabled={isRolling}
                                                    className="p-4 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 disabled:opacity-50 transition-all transform hover:scale-105 flex flex-col items-center gap-2"
                                                >
                                                    <ZapIcon />
                                                    <span className="text-lg">Risky Dice</span>
                                                    <span className="text-xs opacity-90">Roll 1, 2, or 6</span>
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-gray-500">
                                            <p>Waiting for {currentPlayer?.name || 'next player'} to roll...</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DiceRaceGame />, document.getElementById('root'));
    </script>
</body>
</html>